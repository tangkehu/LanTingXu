{% extends "base.html" %}

{% block body %}
<main role="main">
    <div class="border-bottom shadow py-4 mb-4">
        <div class="container">
            <div class="row">
                <div class="col"><span class="h3">兰亭续</span> <span class="lead">文化创意工作室</span> </div>
            </div>
        </div>
    </div>

    <div id="content" class="container mb-5 pb-5">
        <div class="row mb-4">
            <div class="col text-right">
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {{ current_type }}
                  </button>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item" href="{{ url_for('.index') }}">全部类别</a>
                    {% for item in type_list %}
                        <a class="dropdown-item" href="{{ url_for('.index', type_id=item.id) }}">{{ item.name }}</a>
                    {% endfor %}
                  </div>
                </div>
            </div>
        </div>
        <div class="row masonry mr-0"></div>
        <div class="row">
            <div class="col text-center mb-5 loading" style="display: none;">
                <div class="spinner-border" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
            </div>
            <div class="col text-center mb-5 data-null" style="display: none;">
                全部已加载...
            </div>
            <div class="col text-center mb-5 error-load" style="display: none;">
                加载失败，请刷新页面重试...
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block script %}
<script src="https://cdn.bootcss.com/masonry/4.2.2/masonry.pkgd.min.js"></script>
<script src="https://cdn.bootcss.com/jquery.imagesloaded/4.1.4/imagesloaded.min.js"></script>
<script src="https://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.js"></script>

<script type="text/javascript">

    let data_url;
    let setState = function () {  // 记录当前页面状态
        window.sessionStorage.content=$("#content").html();
        window.sessionStorage.url=data_url;
        window.sessionStorage.scroll=$(window).scrollTop();
    };

    $(function(){
        // 商品数据分页无限懒加载瀑布流
        let getGoods = function (){
            if (data_url && $(document).height() - $(window).height() - $(window).scrollTop() < 20){
                let $loading = $('.loading');
                let $dataNull = $('.data-null');
                let $errorLoad = $('.error-load');
                let $masonry = $('.masonry');
                $.ajax({
                    url: data_url,
                    beforeSend: () => $loading.show(),
                    success: function (data) {
                        for (let v of data.items) {
                            let $content = $(
                                '<div class="col-6 col-md-4 col-xl-3 mb-3 pr-0">\n' +
                                '  <a href="/goods_show/'+v[0]+'" onclick="setState()">\n' +
                                '    <img data-original="/static/img_goods/'+v[2]+'" src="/static/img/no-image.jpg" class="img-fluid rounded lazy">\n' +
                                '    <span class="badge badge-pill badge-secondary" style="position: absolute; left:1.5rem; top:0.5rem;">'+v[0]+'</span>' +
                                '  </a>' +
                                '</div>'
                            );
                            $masonry.masonry().append($content).masonry('appended', $content);
                        }
                        $masonry.imagesLoaded(() => $masonry.masonry());
                        setTimeout(function () {
                            $("img.lazy").lazyload({load : () => $masonry.masonry()});
                        }, 200);
                        if (!data.next) $dataNull.show();
                        data_url = data.next;
                    },
                    error: () => $errorLoad.show(),
                    complete: () => $loading.hide()
                });
                data_url = null;
            }
        };
        $(window).scroll(getGoods);

        if (window.sessionStorage.content !== undefined) {
            data_url = window.sessionStorage.url === 'null' ? null : window.sessionStorage.url;
            $("#content").html(window.sessionStorage.content);
            $("img.lazy").lazyload({load : () => $('.masonry').masonry()});
            $(window).scrollTop(parseInt(window.sessionStorage.scroll));
            window.sessionStorage.clear();
        } else {
            data_url = '{{ url_for('.goods_list', tid=type_id, page=1) }}';  // 初始化url
            $(window).scroll();
        }

    });

</script>
{% endblock %}